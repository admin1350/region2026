# Модуль Б. Настройка технических и программных средств информационно-коммуникационных систем

Всё ниже приведённое:

    1. не является официальной рекомендацией или призывом к действию
    2. является частным мнением и не претендует на универсальность
    3. отражает личный опыт и мнение одного человека
    4. основано на субъективном взгляде и не является истиной в последней инстанции для всех
    5. является частным случаем и не может рассматриваться как обязательная к применению инструкция

Время на выполнение модуля: 7 часов
Схема Подкоючения:
![](https://github.com/admin1350/region2026/blob/main/photo/image_png.png)
![](https://github.com/admin1350/region2026/blob/main/photo/image-20-285-29_png.png)
![](photo/image-20-284-29_png.png)
На виртуальных машинах и оборудовании используются следующие версии ОС и технологические решения:
| Название устройства 	| ОС 	                            | vCPU 		| RAM 		| 	SSD  |
| ---------        		| ---------                			| --------- | --------- | -----  |
| rtr-cod 	            | EcoRouterOS (7-jasmine)           | 2 	    | 4 		|	6    |
| fw-cod 	            | Ideco NGFW NOVUM 21 (21.5.99)     | 4 	    | 16 		|	150  |
| sw1-cod 	            | Альт Сервер 11 	                | 1 	    | 1 	    |	10   |
| sw2-cod 	            | Альт Сервер 11 	                | 1 	    | 1 	    |	10   |
| cli-cod 	            | Альт Рабочая станция 11 	        | 2 	    | 2 	    |	20   |
| srv1-cod 	            | Альт Сервер 11 	                | 2 	    | 2 	    |	20   |
| srv2-cod 	            | Альт Сервер 11 	                | 2 	    | 2   	    |	20   |
| sip-cod 	            | SNG7-PBX16 	                	| 2 	    | 2 	    |	20   |
| admin-cod 	        | Альт Рабочая станция 11 	    	| 2 	    | 2 	    |	20   |
| rtr-a 	            | EcoRouterOS (7-jasmine) 	    	| 2 	    | 4 	    |	6    |
| sw1-a 	            | Альт Сервер 11 	            	| 1 	    | 1 	    |	10   |
| sw2-a 	            | Альт Сервер 11 	            	| 1 	    | 1 	    |	10   |
| dc-a 	                | Альт Сервер 11 	            	| 2 	    | 2 	    |	20   |
| cli1-a 	            | Альт Рабочая станция 11 	    	| 2  	    | 2 	    |	20   |
| cli2-a 	            | Альт Рабочая станция 11 	    	| 2 	    | 2 	    |	20   |
| Итого: 	            |                                  	| 28 		|44 		|	362  |

Параметры интернет-провайдеров, предоставляющих услуги организации или клиентам:

| Провайдер 	| Адрес IPv4/Маска 		| Шлюз IPv4 		| AS    |
| -				| -						| -					| -		|
| GIGAFON COD 	| 178.207.179.4/29 		| 178.207.179.1 	| 31133 |
| GIGAFON A 	| 178.207.179.28/29 	| 178.207.179.25 	| 31133 |

В сети GIGAFON COD сделаны настройки BGP:

    1. Соседство устанавливается по IPv4 с адреса шлюза на выделяемый провайдером адрес через физический интерфейс и указанные выше номера автономных систем.
    2. Все провайдеры анонсируют делегируемые префиксы в “интернет”.

На DNS-сервере100.100.100.100 настроена зона ssa2026.ru

VLAN - cod:
| VLAN 	| Название 	| Устройство |
|	-	|	-		|	-		 |
| 100 	| SRV-COD 	| srv1-cod, srv2-cod |
| 200 	| DATA 		| srv1-cod, srv2-cod |
| 300 	| MGMT-COD 	| fw-cod, sw1-cod, sw2-cod, admin-cod |
| 400 	| CLI 	    | cli-cod |
| 500 	| VOIP 		| sip-cod |

| VLAN 	| Название 	| Устройство |
|	-	|	-		|	-		 |
| 100 	| SRV		| dc-a	|
| 200 	| CLI		| cli1-a, cli2-a |
| 300 	| MGMT	 	| rtr-a, sw1-a, sw2-a |

  Проверка будет производиться с использованием доменных имен.

Проверка по IP-адресам выполняться не будет.
# Используемая таблица адресации
 | VM 	     | Network Device 	 | Network  	     | VLAN 	 | IP 	            | Gateway        | 
 | - 	     | 			-		 | 	-			     | -		 | -	            | - 	         |
 | rtr-cod 	 | net1 	         | 178.207.179.0/29  | - 	     | 178.207.179.4  	| 178.207.179.1  | 
 |           | net2 	         | 172.16.1.0/30 	 |           |                  | 172.16.1.1     | 
 | fw-cod 	 | net0 	         | 172.16.1.0/30 	 |           | 172.16.1.2 	    | 172.16.1.1     | 
 |           | net1 	         | 192.168.10.0/24 	 | 100 	     | 192.168.10.254   |                | 
 |           |                   | 192.168.20.0/24 	 | 200 	     | 192.168.20.254   |                | 
 |           |                   | 192.168.30.0/24 	 | 300 	     | 192.168.30.254   |                | 
 |           |                   | 192.168.40.0/24 	 | 400 	     | 192.168.40.254   |                | 
 |           |                   | 192.168.50.0/24 	 | 500 	     | 192.168.50.254   |                |     
 | sw1-cod 	 | SVI 	             | 192.168.30.0/24 	 | 300 	     | 192.168.30.1 	| 192.168.30.254 | 
 | sw2-cod 	 | SVI 	             | 192.168.30.0/24 	 | 300 	     | 192.168.30.2 	| 192.168.30.254 | 
 | cli-cod 	 | net0 	         | 192.168.40.0/24 	 | 400 	     | 192.168.40.40 	| 192.168.40.254 | 
 | srv1-cod  | net0 	         | 192.168.10.0/24 	 | 100 	     | 192.168.10.1 	| 192.168.10.254 | 
 |           | net1 	         | 192.168.20.0/24 	 | 200 	     | 192.168.20.1     |                | 
 | srv2-cod  | net0 	         | 192.168.10.0/24 	 | 100 	     | 192.168.10.2 	| 192.168.10.254 | 
 |           | net1 	         | 192.168.20.0/24 	 | 200 	     | 192.168.20.2     |                | 
 | sip-cod 	 | net0 	         | 192.168.50.0/24 	 | 500 	     | 192.168.50.50 	| 192.168.50.254 | 
 | admin-cod | net0 	         | 192.168.30.0/24 	 | 300 	     | 192.168.30.30 	| 192.168.30.254 | 
 | rtr-a 	 | net1 	         | 178.207.179.24/29 | - 	     | 178.207.179.28 	| 178.207.179.25 | 
 |           | net2 	         | 172.20.10.0/24 	 | 100 	     | 172.20.10.254    |                | 
 |           |                   | 172.20.20.0/24 	 | 200 	     | 172.20.20.254    |                | 
 |           |                   | 172.20.30.0/24 	 | 300 	     | 172.20.30.254    |                | 
 | sw1-a 	 | SVI 	             | 172.20.30.0/24 	 | 300 	     | 172.20.30.1 	    | 172.20.30.254  | 
 | sw2-a 	 | SVI 	             | 172.20.30.0/24 	 | 300 	     | 172.20.30.2 	    | 172.20.30.254  | 
 | dc-a 	 | net0 	         | 172.20.10.0/24 	 | 100 	     | 172.20.10.10 	| 172.20.10.254  | 
 | cli1-a 	 | net0 	         | 172.20.20.0/24 	 | 200 	     | 172.20.20.1 	    | 172.20.20.254  | 
 | cli2-a 	 | net0 	         | 172.20.20.0/24 	 | 200 	     | 172.20.20.2 	    | 172.20.20.254  | 

# Настройка виртуальной машины ISP
### Задача настроить:

    Имя
    IP-адреса
    Перессылка пакетов
    NAT
    DNS
    NTP
    BGP
### Вариант реализации:

Настройка имени на устройстве:

        hostnamectl set-hostname isp; exec bash

так же рекомендуется указать имя в файле /etc/sysconfig/network:

    vim /etc/sysconfig/network

указать имя в параметре HOSTNAME:

![](photo/po1.png)

Настройка IP-адресов:

    ens19 - доступ в сеть Интернет (SDN Simple Zone)
    ens20 - сеть в сторону rtr-cod
    ens21 - сеть в сторону rtr-a

![](photo/po2.png)

В данном случае для доступа в сеть Интернет на ISP будет задаваться статическая конфигурация, поэтому файл options для интерфейса ens19 выглядит следующим образом:

![](photo/po3.png)

Копируем рекурсивно директорию ens19 для интерфейсов ens20 и ens21, т.к. файл options будет выглядеть аналогичным обра

    cp -r /etc/net/ifaces/ens19 /etc/net/ifaces/ens20
    cp -r /etc/net/ifaces/ens19 /etc/net/ifaces/ens21
Задаём соответствующие IP-адреса на интерфейсы:

    echo "100.100.100.100/24" > /etc/net/ifaces/ens19/ipv4address
    echo "178.207.179.1/29" > /etc/net/ifaces/ens20/ipv4address
    echo "178.207.179.25/29" > /etc/net/ifaces/ens21/ipv4address
Задаём IP-адрес шлюза по умолчанию и DNS-сервера (временно, для установки необходимых пакетов):

    echo "default via 100.100.100.1" > /etc/net/ifaces/ens19/ipv4route
    echo "nameserver 77.88.8.8" > /etc/net/ifaces/ens19/resolv.conf

 Включаем возможность перессылки пакетов:
Для того чтобы устройство ISP могло пересылать пакеты с интерфейса на интерфейс, необходимо включить пересылку пакетов (forwarding)
        Для этого следует в конфигурационном файле /etc/net/sysctl.conf в параметре                       net.ipv4.ip_forward = 0 заменить значение с 0 на 1

    sed -i "s/net.ipv4.ip_forward = 0/net.ipv4.ip_forward = 1/g" /etc/net/sysctl.conf


Для применения настроек, необходимо перезагрузить службу network

    systemctl restart network
Проверить:
    IP-адреса на интерфейсах:

![](photo/po4.png)

Наличие шлюза по умолчанию и DNS:

![](photo/po5.png)

Перессылку пакетов и доступ в сеть Интернет:

![](photo/po6.png)

Установим iptables для настройки NAT:

    apt-get update && apt-get install -y iptables


Реализацию сетевой трансляции адресов с помощью iptables можно выполнить одной командой:
        где, ens19 внешний интерфейс, подключённый к магистральному провайдеру
        также реалиуем трансляцию адресов только из конкретных сетей rtr-cod и rtr-a

    iptables –t nat –A POSTROUTING -s 178.207.179.0/29 –o ens19 –j MASQUERADE
    iptables –t nat –A POSTROUTING -s 178.207.179.24/29 –o ens19 –j MASQUERADE
Сохраняем правила iptables на постоянной основе (после перезагрузки):
    
    iptables-save >> /etc/sysconfig/iptables
Включаем и добавляем в автозагрузку службу iptables:

    systemctl enable --now iptables
Проверить, наличие правила в iptables, а именно в таблице nat, в цепочек POSTROUTING:


![](photo/po7.png)

Для установки и дальнейшей настройки DNS-сервера, необходимо выполнить установку пакета BIND:

    apt-get install bind bind-utils -y
После установки пакета bind приведём конфигурационный файл /etc/net/ifaces/ens19/resolv.conf к следующему виду:

![](photo/po8.png)

Для применения настроек, необходимо перезагрузить службу network

    systemctl restart network

Далее выполняется редактирование конфигурационного файла /var/lib/bind/etc/options.conf согласно скриншоту

    vim /var/lib/bind/etc/options.conf
где:
    listen-on параметр определяет адреса и порты, на которых DNS-сервер будет слушать запросы;
    В параметре forwarders указываются сервера, куда будут перенаправляться запросы, на которые нет информации в локальной зоне;
    allow-query – IP-адреса и подсети от которых будут обрабатываться запросы;

![](photo/po9.png)

Далее необходимо добавить зоны прямого и обратного просмотра в файл /var/lib/bind/etc/rfc1912.conf:

    vim /var/lib/bind/etc/rfc1912.conf
Добавляем следующее содержимое (в конец файла):

![](photo/po10.png)

Создаём файл зоны прямого просмотра из шаблона:

    cp /var/lib/bind/etc/zone/empty /var/lib/bind/etc/zone/ssa2026.ru
 
 Необходимо сконфигурировать файл ssa2026.ru:

    vim /var/lib/bind/etc/zone/ssa2026.ru
который является прямой зоной следующим образом:

![](photo/po11.png)

Задать соответствующие права на файл:

    chown root:named /var/lib/bind/etc/zone/ssa2026.ru
После того, как конфигурация зон была завершена, для корректной работы службы bind необходимо выполнить команду:

    rndc-confgen > /var/lib/bind/etc/rndc.key 
Затем выполнить команду:

    sed -i ‘6,$d’ /var/lib/bind/etc/rndc.key
Результат:

![](photo/po12.png)

Проверить конфигурационные файлы и файлы зон:

![](photo/po13.png)

После этого можно запустить службу bind: 

    systemctl enable --now bind.service

Проверить работоспособность DNS:

![](photo/po14.png)

Настроить часовой пояс:

    timedatectl set-timezone Europe/Moscow

На JeOS возможно потребуется установка пакета tzdata: 

    apt-get install -y tzdata
Проверить:
    
    timedatectl

![](photo/po15.png)

Редактируем конфигурационный файл /etc/chrony.conf:

    vim /etc/chrony.conf
Добавляем следующую информацию:

![](photo/po16.png)

Перезагружаем службу chronyd для применения изменений:

    systemctl restart chronyd

Проверяем:

![](photo/po17.png)

Устанавливаем пакет frr для настройки маршрутизации:

    apt-get install -y frr

 В конфигурационном файле "/etc/frr/daemons" необходимо активировать выбранный протокол для дальнейшей реализации его настройки:

    vim /etc/frr/daemons
 переводим bgpd=no в bgpd=yes - для BGP:

![](photo/po18.png)

Включаем и добавляем в автозагрузку службу frr:

    systemctl enable --now frr

Проверить:

![](photo/po19.png)

 Настраиваем BGP - переходим в интерфейс frr при помощи "vtysh":

![](photo/potest.png)

Реализуем настройку BGP:
    перейдите в режим конфигурирования работы протокола BGP указав № AS;
    задайте  router-id;
    добавьте адрес и номер AS соседа;
    перейдите в режим настройки address family;
    укажите что маршрутизатор ЦОД должен получать маршрут по умолчанию по BGP;
    сохраните конфигурацию

![](photo/potest1.png)

Проверить

![](photo/potest2.png)

Проверка подключения маршрутизатора rtr-cod по bgp:
    без сохранения настроек, чтобы при перезугрузки конфигураци не сохранилась

    ecorouter>en
    ecorouter#conf t
    ecorouter(config)#interface isp
    ecorouter(config-if)#ip address 178.207.179.4/29
    ecorouter(config-if)#exit
    ecorouter(config)#  
    ecorouter(config)#port te0
    ecorouter(config-port)#service-instance te0/isp
    ecorouter(config-service-instance)#encapsulation untagged 
    ecorouter(config-service-instance)#connect ip interface isp 
    ecorouter(config-service-instance)#exit
    ecorouter(config-port)#exit
    ecorouter(config)#
    ecorouter(config)#router  bgp 64500
    ecorouter(config-router)#bgp router-id 178.207.179.4
    ecorouter(config-router)#neighbor 178.207.179.1 remote-as 31133
    ecorouter(config-router)#exit
    ecorouter(config)#exit
    ecorouter#

Результат:

![](photo/po26.png)

![](photo/po23.png)

![](photo/po24.png)

![](photo/po25.png)

